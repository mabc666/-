# 数据链路层与局域网
- 数据链路层服务  
- 差错控制  
- 多路访问控制协议  
- 局域网
- 点对点协议  
---   
### 一、数据链路层服务  
一般数据链路层都提供以下几点服务：  
- 组帧：在发送方要做的事情就是要将网络数据报封装到数据帧中，在数据报上增加一个帧头和一个帧尾。帧头中通常包含发送结点和接收结点的地址信息，帧尾通常包含用于差错检测额的差错编码。  
- 链路接入：物理链路可以分为点对点链路和广播链路两大类。在点对点链路中，发送结点和接收结点独占通信链路，只要链路处于空闲状态。在广播链路中，通信链路被多个结点共享任意两个结点同时通过链路的话会产生干扰。因此对于广播链路来说，各个结点必须运行媒体访问控制协议（MAC），来协调各个结点使用共享的物理媒介，实现帧的成功传输。  
- 可靠交付：其实在数据链路层也是支持数据的可靠传输的，其方法与传输层的办法都是一样的，但是并不是所有的链路层协议都有的。其实这种可靠交付主要应用于出错率较高的链路中，例如无线链路。而比如光纤链路、双绞线链路等都，都不是很必要。  
- 差错控制：在链路层一般都采用不同的差错控制，比如说收到错误的帧一般都是通过确认重传，或者直接丢弃。  

### 二、差错控制的基本方式  
由于信号在信道传输过程中，会受到各种噪声的干扰，从而导致传输差错。噪声大致分为两种一种是随机噪声（热噪声，传输介质的噪声），还有一种是冲击噪声（雷击等）。  
1、差错控制的基本方法  
- 检测重发：这就跟传输层的停-等和滑动窗口比较相似，在发现错误后请求重发。  
- 前向纠错（FEC）：这种差错控制的方法是利用了纠错码，发送端将纠错码和数据一起发送给接收端，接收端收到以后进行检测，如果发现错误就把错误直接纠正。无需重传等。  
- 反馈校验：就是接收端将接收到的信息全部反回给发送端，然后检测是否相同，如果发现错误就立即重发，知道接受到正确的数据。  
- 检错丢弃：对于有些容错率比较高的应用（比如说流媒体等），那碰到错误的帧可以就直接丢弃。  

2、差错编码的基本原理  
简单的来将就是比如发送端发送2个数据信息，接收端收到的可能是00、01、10、11，如果在其后面将其重复那么就变成0000、0101、1010、1111这样如果接收到0100这样的数据就断定其是错误的。其基本原理就是在其数据后面附上一段由数据的来的差错编码从而根据这个差错编码来判定其正确性。  
3、差错编码的检错和纠错能力  
不同的差错编码的检错和纠错能力都是不同的，差错编码的纠错或检错能力与编码集的海明距离有关。两个等长的码字之间，对应位不同的位数，称为两个码字的海明距离。因此可以定义一个编码集，例如{10010110，10100101，10110100，10010110}这样一个编码集，其最小的海明距离为2。  
对于检错编码来说，如果海明距离为n+1，那么该差错编码可以检测n位的差错。
对于纠错编码来说，如果海明距离位2n+1，那么该差错编码可以纠正n位的差错。  

4、典型差错编码  
奇偶校验码：这种编码最简单只要在其最后添加一位，使其整个数据加差错编码中的1的数量，满足奇数或者偶数（如果采用奇校验的话就凑成奇数）。  

海明码：海明码的差错编码比较复杂一点。首先举一个例子，假如由一个信息位为k=n-1位的比特流，a<sub>n-1</sub>a<sub>n-2</sub>a<sub>n-3</sub>...a<sub>1</sub>，加上偶校验位a<sub>0</sub>后，构成一个n位的码字。在接收端可以按照下面的关系式来检测：  
<center> 

```math
S=a_{n-1} \bigoplus a_{n-2} \bigoplus a_{n-3} \bigoplus ...a_{1} \bigoplus  a_{0} 
```

</center >
结果S=0的话那么说明是正确的，S=1的话说明出现了错误。 

上面的式子称为监督关系式，S称为校正因子。  
在奇偶校验下只有一个监督关系式，一个矫正因子，其值只有两种（0或1），所以只能检测出是否发生了错误而不能把错误纠正出来。    
一般来说，信息位为k位，增加r位冗余位，构成n=k+r位码字。若希望用r个监督关系式来产生r个矫正因子来区分错误位置则要求  
<center>  

```math
2^r \geq  k+r+1
```

        
       
</center>  
假设k=4 如果要满足上面的关系式的话r&ge;3。现在取r=3,则n=4+3=7。也就是说在，a<sub>6</sub>a<sub>5</sub>a<sub>4</sub>a<sub>3</sub>，后面加上a<sub>2</sub>a<sub>1</sub>a<sub>0</sub>，构成7位码字。其中a<sub>2</sub>a<sub>1</sub>a<sub>0</sub>分别由4位信息位中某几位异或运算出来的。那么在校验时，分别与这些位进行异或如果结果是0那么说明正确，如果不是0说明出错了。根据其校验因子来指示到底是哪个位出现了错误。  


S<sub>2</sub>S<sub>1</sub>S<sub>0</sub> | 000 | 001 | 010 | 100 | 011 | 101 | 110 | 111
---|---|---|---|---|---|---|---|---
错误编码 | 无错 | a<sub>0</sub> | a<sub>1</sub> | a<sub>2</sub> | a<sub>3</sub> | a<sub>4</sub> | a<sub>5</sub> | a<sub>6</sub>  
根据上面的的信息就可以得出如果a2，a4，a5，a6的一个位错都可以使S<sub>2</sub>=1。这样就可以得到监督关系：  
 <center>  

```math
S_2 = a_2 \bigoplus a_4 \bigoplus a_5 \bigoplus a_6      

S_1 = a_1 \bigoplus a_3 \bigoplus a_5 \bigoplus a_7    

S_0 = a_0 \bigoplus a_3 \bigoplus a_4 \bigoplus a_6  
```

        
       
</center>      
由此可以求得冗余位的编码：   

```math
a_2 = a_4 \bigoplus a_5 \bigoplus a_6  

a_1 = a_3 \bigoplus a_5 \bigoplus a_6  

a_0 = a_3 \bigoplus a_4 \bigoplus a_6
```

海明码的编码效率随着信息位的长度增长而增长。  
  
    
  
  
循环冗余码（CRC）：  
CRC循环冗余校验是基于生成多项式，举个例子假设生成多项式为G(x) = x<sup>4</sup> + x + x<sup>0</sup> ，请为位串10111001进行CRC编码。根据生成式所对应的比特串是10011，然后在位串后面添加4个0（根据多项式中指数最大的那个数字决定），新串就是101110010000，接下来按求余数的过程算出余数来（不进位借位对应的位进行异或）然后将余数添加到老的位串后面替换掉4个0的位置。    


### 三、多路访问控制协议  
1、信道划分MAC协议  
MAC协议的基本任务就是解决信道共享的问题。多路复用技术时实现物理信道共享的经典技术，其基本思想是将信道资源划分后，分配给不同的结点。常见的复用技术包括频分多路复用（FDM）、时分多路复用（TDM）、波分多路复用（WDM）和码分多路复用（CDM）。接下来就逐一简单介绍以下这些技术。  
FDM：在频域内将信号带宽划分为多个子信道，并利用载波调制技术，将原始信号调制到对应某个子信道的载波信号上，使得多路信号不会起冲突。  
TDM：是一种时域划分，即将通信信道的传输信号在时域内划分成多个等长的时隙，每路信号占用不同的时隙，在时域上不重叠。这样多路传输的时候也不会冲突。时分复用也分两种一种叫同步时分复用就是按固定的顺序把时隙分配给不同路使用，然后一轮结束以后再来一轮循环往复，这种时隙分配有个缺点就是当其中有哪条路如果没数据发那整个链路就处于空闲状态所以效率比较低。因此就想出个异步时分复用，根据用户所要发送的数据量来分配时隙。  
WDM:波分复用技术，广泛应用于光纤信道中，其实质是一种频分复用的技术，只是在光纤中，光载波频率很高，通常用光的波长来代替频率讨论。在波分复用技术中多路信号通过使用不同波长的信号，将信息传输出去之后，到了目的地再进行分解。  
CDM：码分复用是用一组包含互相正交的码字的码组携带多路信号。  

2、随机访问MAC协议  
###### ALOHA协议  
ALOHA协议分为两种：纯ALHOA和时隙ALHOA  
纯ALHOA：工作原理非常简单，就是任何一个站点有数据要发送就直接发送至信道，然后开始监听该信道，等待（通常是电波传输到最远的站点然后返回的总时间）收到应答信息。如果没有收到应答信息的话，那就等待一个随机时间重新发送，直到收到应答信息为止。 其信道的利用率最高为18.4%。   
时隙ALOHA：时隙ALHO的基本思想是将信道的时间分散成离散的时隙，每个时隙为发送一帧所需的发送时间。通讯站只能在每个时隙开始的时候发送帧，如果在发送过程中出现冲突，那就在下个时隙以概率P重发该帧，以（1-P）的概率不发送该帧，直到帧发送成功。时隙ALOHA协议需要所有通讯站在时间上同步。其信道最高的利用率为36.8%。  

###### 载波监听多路访问协议(CSMA)  
CSMA是载波检测（侦听）多路访问。它检测其他站的活动情况，据此调整自己的行为。分为以下几类：  
1-持续CSMA(1-persistent   CSMA)：当信道忙或发生冲突时，要发送帧的站，不断持续侦听，一有空闲，便可发送. 其中，长的传播延迟和同时发送帧，会导致多次冲突，降低系统性能.  
非持续CSMA：它并不持续侦听信道，而是在冲突时，等待随机的一段时间.它有更好的信道利用率，但导致更长延迟。  
p-持续CSMA：它应用于分槽信道，按照P概率发送帧.即信道空闲时，这个时槽，欲发送的站P概率发送，Q=1-P概率不发送.若不发送，下一时槽仍空闲，同理进行发送.若信道忙，则等待下一时槽，若冲突，则等待随机的一段时间，重新开始。    
###### 带冲突检测的载波监听多路访问协议（CSMA/CD）   
前面说了就算在数据发送前进行监听信道，还是会在数据发送时产生冲突。当两个帧发生冲突时，不仅导致两个数据都被破坏，也会使得信道无法被其他站所使用。为了解决这以问题，就是当它在发送时也进行冲突检测，一旦发现有冲突就立即停止发送数据，以免更多的浪费。  
CSMA/CD的基本原理：通信站使用CSMA协议进行数据发送，在发送期间如果检测到了冲突，立即停止发送，并法出一个冲突强化信号，使所有通信站都直到冲突的发送。发出冲突信号以后，等待一个随机时间，再重复上述过程。因此信道有3种状态，传输状态，竞争状态，空闲状态。  
由于信道传输数据的时候有延迟，所以当一个时刻发现信道时空闲的，但是其实另一头的终端已经发送了数据，只是还没有传播过来，然后这一头的终端认为信道时空闲的，那么这样就会发生冲突导致数据传输失败。
为了判断是否发生冲突其中两个站之间的最远距离，信号传播速度，数据帧长度，信道传输速率要满足以下关系式：  
<center>

```math
\frac{L_min}{R}  \geq \frac{2D_max}{v} 
```
</center>
解释以下这个公式的由来，公式左半边是传输延迟，而公式由半边是的D<sub>max</sub>/v是单向传播延迟。当你的数据快传到目的地，然后目的地还没有检测到信道中有数据，然后就开始发送数据了，这样其实就是在最远处发生了碰撞，然后目的地发一个冲突强化信号，通知发送方。所以如果是这种情况的话，发送方要监听的时间要从发送出去以后直到冲突强化信号回来这么久，所以要有2个单向传播延迟时间。这是最坏的情况了。    

###### 受控接入MAC协议  
这种受控式的接入MAC协议也分两种：集中式控制，和分散式控制。  
集中式控制：比如说总线轮询式，就是有一台主控主机然后不断的轮询所有的主机，询问是否有数据要发送。  
分散式控制：其实这种控制方式就是令牌环控制网络，其发送原理是，就是有一个令牌帧，然后在一个拓扑结构为环形的网络结构中传递，如果有谁想发送就将令牌改成忙，进行发送，发送完之后产生一个新的令牌发送给下一个站点。  

### 局域网  
###### 数据链路层寻址与ARP  
数据链路层的帧，发送时需要携带发送帧结点的数据链路层的地址，以及接收帧结点的数据链路层地址，标识帧的发送方和接收方。  
1、MAC地址  
MAC地址是指的，网络设备（网卡）的链路层地址，用于标识局域网中唯一的结点或接口即每个MAC地址都对应于一个结点或接口。MAC地址长48位，6字节，通常采用16进制数来表示，通常都是用’：‘或者’-‘，将6个16进制数给连接起来的，例如00-2A-E1-76-8C-39或者是00:2A:E1:76:8C:39。有一些特别的MAC地址比如说FF-FF-FF-FF-FF-FF这是一个链路层的广播MAC地址。一般来说MAC地址都是固化在网卡中的但是现在还是能够通过软件进行修改的。  
MAC地址分配就不详细叙述了，是由IEEE统一管理分配的。  
2、地址解析协议（ARP）  
其实就是根据ARP表，由本网内的IP地址得到MAC地址。在ARP表中IP和MAC有着映射关系。  
如果发送方在发送的时候在ARP表中，查询不到对应的表项那么就发送一个ARP查询帧（广播出去要查询的IP地址），之后如果有主机与之匹配的化那么就返回一个MAC地址给查询方。这里需要注意的是查询帧是广播的而响应帧其实是单播的，因为查询帧中包含了查询方的IP和MAC地址。  

###### 以太网  
以太网采用的是CSMA/CD的MAC协议，根据上面有个公式，对于帧的长度是有最小限制的，以太网的帧最小要64字节然后数据部分最小要46字节不够要填充，具体如何推算出来的就不详细解释了。  
1、以太网帧结构  
![image](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1533014435137&di=1eeff41a3a3c56f6a9c3feffb6311fb5&imgtype=jpg&src=http%3A%2F%2Fimg2.imgtn.bdimg.com%2Fit%2Fu%3D2536639537%2C218551072%26fm%3D214%26gp%3D0.jpg)  
目的地地址和源地址都是MAC地址，类型指的是上层协议的类型，CRC是循环冗余校验码。  
以太网向网络层提供的也是无连接不可靠的服务。  
2、以太网技术  
- 10Base-T：传输速率10Mbit/s  
- 快速以太网：传输速率100Mbit/s，使用802.3u协议。
- 千兆以太网：传输速率1000Mbit/s，使用802.3ab的协议。  
- 万兆以太网络：速率高达10Gbit/s，使用802.3ae协议。  

###### 交换机  
交换机是一个只有两层（物理层和链路层）的网络设备，其本质就是根据设定的规则转发链路层的帧。其转发规则也是根据转发表来只是其转发表中是MAC地址和端口
号的映射，而且它也会向ARP一样如果转发表中没有就发送查询帧，来查询映射关系，然后发送。  

###### 虚拟以太网(VLAN)  
当你需要从一个地方移动到另一个地方的时候，还想在原来的局域网中工作时，由于网络设备早已架设好，不方便移动，这时就产生了一个新的技术就叫虚拟局域网。这种技术可以不移动原先的网络设备只通过交换机或者路由器来实现虚拟的局域网，只通过连线就可以使你仍然像在原来的地方办公一样。  
划分VLAN的方法有三种：  
1、基于交换机端口划分，局域网的网络管理员可以按照以太网交换机的端口定义VLAN成员，通常每个交换机端口属于一个VLAN。这样的配置方式，主机较多时工作量较大，主机端口变动时，需要改变其端口所属的VLAN，但是这种方式操作简单。 

2、基于MAC地址划分，基于MAC地址划分虚拟局域网，是按每个连接到交换机的主机MAC地址定义VLAN成员的。基于MAC地址划分的方式的话，前期要进行大量的用户配置，所以如果用户数量非常多的话，工作量较大，并且每个交换机端口保存了多个MAC地址，从而降低了执行的效率。但是这种方式的优点是，移动主机后无需重新配置VLAN。

3、基于上层协议类型或地址划分，根据链路层帧所携带的数据上层协议类型（如IP）或地址（IP地址）定义VLAN成员，这种方法优点是有利于组成基于应用的VLAN。这种方式最大的缺点就是，检查报文中的网络地址比对检查帧中的MAC地址开销更大。  

### 点对点链路协议  
前面介绍的MAC协议都是用于共享链路的，网络中还有一类链路是点对点链路，这类链路一般用于广域网中。下面有两种点对点链路协议：PPP和HDLC协议。  
###### PPP协议  
PPP协议是现在全世界用的比较多的一种协议。PPP协议处理错误检测、支持多种上层协议、允许在连接时刻协商IP地址、允许身份认证等。  
PPP主要的3类功能如下：  
- 成帧：确定一个帧的开始和结束，帧格式支持错误检测。  
- 链路控制协议（LPC）：用于启动线路、检测线路、协商参数及关闭线路。  
- 网络控制协议（NPC）：用于协商网络层选项，并且协商方法与使用的网络层协议独立。    
PPP帧格式：  
![image](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1533019996604&di=3add276830145a72c0f900bfa8b4b267&imgtype=0&src=http%3A%2F%2Fimg.it610.com%2Fimage%2Finfo2%2F70b7f8bd1e524fa5a324c7de050e1190.png)   
PPP帧中的地址字段和控制字段，在PPP协议建立之初，可以通过协商省略不用，另外协议字段和校验字段分别占1字节或者2字节和2字节或4字节，这也是在最初建立的时候协商的，这些都是通过LCP来完成的。    
还有就是NCP的功能是用于给新来的主机配置网络层，NCP给新接入的主机分配一个临时IP地址，使PC机成为因特网上的一个主机。通信完成后，NCP释放网络层连接，收回分配出去的IP地址，接着LCP释放数据链路连接，最后释放的是物理层的连接。  
还有一个二义性的问题因为在PPP中第一个标志字段是01111110，有可能数据中也会有这个位串，如果数据中也出现了这个位串的话，那就再其前面加上一个转义字节01111101，这样二义性问题就解决了。  
###### HDLC协议  
HDLC相对于PPP来说其可以实现点对点和点对多点链路，而PPP只能工作于单个发送方和单个接收方。  
HDLC帧格式：  
![image](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1533021200020&di=d5172a4c7d59bb8b85fb8db1a1bec940&imgtype=0&src=http%3A%2F%2Fwww.elecfans.com%2Farticle%2FUploadPic%2F2008-7%2F2008722155418376.gif)  
其中01111110是定界符，地址字段用于标识一个终端，控制字段用作序列号、确认、查询、结束，校验和采用CRC。  
HDLC有三种类型的帧：信息帧（I帧）、管理帧（S帧）和无序号帧（U格式）。  
HDLC中如果出现5个1就立即填充1个0，使其不会出现6个1，以免出现二义性。

